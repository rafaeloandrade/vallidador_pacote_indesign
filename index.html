<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Validador de Pacote InDesign</title>
  <!-- Fonte Bebas Neue (só pro título) -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    h1 {
      font-family: 'Bebas Neue', sans-serif;
      color: #d1006c;
      margin-bottom: 10px;
      font-size: 42px;
      letter-spacing: 1px;
    }
    p.subtitle {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 16px;
      color: #555;
    }
    .upload-box {
      border: 2px dashed #d1006c;
      padding: 30px;
      background: #fff;
      text-align: center;
      border-radius: 10px;
      cursor: pointer;
      width: 400px;
      margin-bottom: 20px;
      transition: background 0.2s;
      user-select: none;
    }
    .upload-box.dragover {
      background: #ffe6f2;
    }
    #fileInput {
      display: none;
    }

    .file-info {
      display: none;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px 15px;
      margin-bottom: 20px;
      max-width: 400px;
      width: 100%;
      font-size: 14px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .file-icon {
      width: 36px;
      height: 36px;
      flex: 0 0 36px;
      display: inline-block;
    }
    .file-meta { display:flex; flex-direction:column; align-items:flex-start; gap:2px; }
    #fileName { font-weight: 600; color:#333; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:320px; }
    #fileSize { font-size:12px; color:#666; }

    .result {
      margin-top: 10px;
      padding: 15px;
      border-radius: 8px;
      max-width: 500px;
      text-align: left;
    }
    .success {
      background: #e6ffed;
      border: 1px solid #1a7f37;
      color: #1a7f37;
    }
    .error {
      background: #ffe6e6;
      border: 1px solid #cc0000;
      color: #cc0000;
    }
    ul {
      margin-top: 10px;
      padding-left: 20px;
    }
    ul li {
      margin: 4px 0;
    }
    .ok { color: #1a7f37; }
    .fail { color: #cc0000; }
    footer {
      margin-top: 40px;
      text-align: center;
      font-size: 14px;
      color: #333;
    }
    footer img {
      margin-top: 10px;
      max-width: 600px;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .copyright {
      margin-top: 10px;
      font-size: 10px;
      color: #222;
      opacity: 0.7;
    }
    .copyright a {
      color: #222;
      text-decoration: none;
    }
    .copyright a:hover {
      text-decoration: underline;
    }

    @media(max-width:460px){
      .upload-box, .file-info { width: 100%; }
      h1 { font-size: 36px; }
    }
  </style>
</head>
<body>
  <h1>Validador de Pacote InDesign</h1>
  <p class="subtitle">Envie o arquivo .zip para verificar se segue os parâmetros exigidos</p>

  <label for="fileInput" class="upload-box" id="uploadBox" aria-hidden="false">
    Clique ou arraste o arquivo .zip aqui
  </label>
  <input type="file" id="fileInput" accept=".zip" aria-label="Enviar arquivo zip">

  <!-- Caixa com ícone magenta inline, nome e tamanho -->
  <div id="fileInfo" class="file-info" aria-live="polite">
    <svg class="file-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <rect x="3" y="4" width="14" height="16" rx="2" stroke="#d1006c" stroke-width="1.6" fill="rgba(209,0,108,0.04)"/>
      <path d="M7 8H15" stroke="#d1006c" stroke-width="1.4" stroke-linecap="round"/>
      <path d="M7 12H15" stroke="#d1006c" stroke-width="1.4" stroke-linecap="round"/>
      <path d="M7 16H13" stroke="#d1006c" stroke-width="1.4" stroke-linecap="round"/>
      <rect x="17" y="8" width="4" height="8" rx="1" fill="#d1006c" opacity="0.12"/>
    </svg>

    <div class="file-meta">
      <div id="fileName">Nenhum arquivo selecionado</div>
      <div id="fileSize"></div>
    </div>
  </div>

  <div id="result" class="result" style="display:none;"></div>

  <footer>
    <p>Não salvou corretamente? Relembre o passo a passo:</p>
    <img src="Captura de Tela 2022-08-22 às 10.55.28.png" alt="Passo a passo InDesign">
    <div class="copyright">
      © <a href="https://www.behance.net/rafael_andrade" target="_blank" rel="noopener noreferrer">Rafael Andrade</a>
    </div>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const resultDiv = document.getElementById('result');
    const uploadBox = document.getElementById('uploadBox');
    const fileInfo = document.getElementById('fileInfo');
    const fileNameEl = document.getElementById('fileName');
    const fileSizeEl = document.getElementById('fileSize');

    // clique
    fileInput.addEventListener('change', handleFile);

    // drag & drop
    uploadBox.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadBox.classList.add('dragover');
    });
    uploadBox.addEventListener('dragleave', () => {
      uploadBox.classList.remove('dragover');
    });
    uploadBox.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadBox.classList.remove('dragover');
      if (e.dataTransfer.files.length > 0) {
        handleFile({ target: { files: e.dataTransfer.files } });
      }
    });

    function formatBytes(bytes, decimals = 2) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const dm = decimals < 0 ? 0 : decimals;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }

    function isArtifactPath(p) {
      // ignora artefatos comuns (MAC, Thumbs, resource forks)
      const lower = p.toLowerCase();
      if (lower.startsWith('__macosx')) return true;
      if (lower.includes('/._')) return true;
      if (lower.startsWith('._')) return true;
      if (lower.includes('thumbs.db')) return true;
      return false;
    }

    async function handleFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      // mostrar info do arquivo
      fileInfo.style.display = 'flex';
      fileNameEl.textContent = file.name;
      fileSizeEl.textContent = formatBytes(file.size);

      try {
        const jszip = new JSZip();
        const content = await jszip.loadAsync(file);

        // entries originais tal como no zip (podem conter trailing slash)
        const origEntries = Object.keys(content.files);

        // construir array de objetos com propriedades úteis
        const items = origEntries.map(orig => {
          const trimmed = orig.replace(/^\/+|\/+$/g, ''); // remove slashes nas pontas
          const parts = trimmed === '' ? [] : trimmed.split('/');
          const isDir = !!content.files[orig].dir;
          return { orig, trimmed, parts, isDir };
        }).filter(it => it.trimmed !== '');

        // filtrar artefatos na lógica de detecção de prefixo
        const candidatePrefixes = new Set();
        let rootFileCount = 0;
        items.forEach(it => {
          if (isArtifactPath(it.trimmed)) return;
          if (it.parts.length === 1) {
            if (!it.isDir) rootFileCount++;
          } else if (it.parts.length > 1) {
            candidatePrefixes.add(it.parts[0]);
          }
        });

        // decidir se há UMA pasta wrapper (ex: "Pasta revista amamentacao - certa/")
        let normalizedItems;
        if (candidatePrefixes.size === 1 && rootFileCount === 0) {
          const prefix = Array.from(candidatePrefixes)[0] + '/';
          normalizedItems = items.map(it => {
            let norm = it.trimmed.startsWith(prefix) ? it.trimmed.slice(prefix.length) : it.trimmed;
            return { ...it, norm, normLower: norm.toLowerCase() };
          });
        } else {
          normalizedItems = items.map(it => ({ ...it, norm: it.trimmed, normLower: it.trimmed.toLowerCase() }));
        }

        // agora contar apenas arquivos (isDir === false) e ignorando artefatos
        const realFiles = normalizedItems.filter(it => !it.isDir && !isArtifactPath(it.normLower));

        const inddCount = realFiles.filter(it => /^[^/]+\.indd$/i.test(it.norm)).length;
        const idmlCount = realFiles.filter(it => /^[^/]+\.idml$/i.test(it.norm)).length;
        const pdfCount  = realFiles.filter(it => /^[^/]+\.pdf$/i.test(it.norm)).length;
        const linksCount = realFiles.filter(it => it.normLower.startsWith('links/') ).length;
        const fontsCount = realFiles.filter(it => it.normLower.startsWith('document fonts/') ).length;

        const checks = {
          "Arquivo .indd": inddCount,
          "Arquivo .idml": idmlCount,
          "Arquivo .pdf": pdfCount,
          "Pasta Links com arquivos": linksCount,
          "Pasta Document Fonts com arquivos": fontsCount
        };

        const success = Object.values(checks).every(count => count > 0);

        resultDiv.style.display = "block";
        resultDiv.className = "result " + (success ? "success" : "error");

        resultDiv.innerHTML = success
          ? "<strong>✅ Seu arquivo parece estar correto!</strong>"
          : "<strong>❌ O pacote não está completo. Veja os itens abaixo:</strong>";

        const ul = document.createElement('ul');
        for (let [label, count] of Object.entries(checks)) {
          const li = document.createElement('li');
          li.className = count > 0 ? 'ok' : 'fail';
          li.textContent = (count > 0 ? '✔ ' : '✘ ') + label + (count > 0 ? ` (${count} encontrado${count > 1 ? 's' : ''})` : ' (nenhum encontrado)');
          ul.appendChild(li);
        }
        resultDiv.appendChild(ul);

      } catch (err) {
        resultDiv.style.display = "block";
        resultDiv.className = "result error";
        resultDiv.innerHTML = "<strong>❌ Erro ao ler o arquivo .zip. Verifique se o arquivo está íntegro.</strong>";
        console.error(err);
      }
    }
  </script>
</body>
</html>
